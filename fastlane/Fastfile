# frozen_string_literal: true

default_platform(:ios)

platform :ios do
  ############################################################
  # Felles helpers
  ############################################################

  before_all do
    require 'base64'
    issuer_id = ENV['FASTLANE_ISSUER_ID']
    key_id    = ENV['FASTLANE_KEY_ID']
    key_b64   = ENV['FASTLANE_KEY']

    UI.user_error!("FASTLANE_ISSUER_ID is missing") if issuer_id.to_s.strip.empty?
    UI.user_error!("FASTLANE_KEY_ID is missing")     if key_id.to_s.strip.empty?
    UI.user_error!("FASTLANE_KEY (base64) is missing") if key_b64.to_s.strip.empty?

    decoded = Base64.decode64(key_b64)
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: decoded,
      duration: 1200,
      in_house: false
    )
  end

  private_lane :ensure_app_identifiers! do
    ids = ENV['APP_IDENTIFIERS'].to_s.split(',').map(&:strip).reject(&:empty?)
    if ids.empty?
      UI.user_error!("APP_IDENTIFIERS is empty. Upstream step should auto-detect, or set a repo variable 'APP_IDENTIFIERS' with a comma-separated list of bundle identifiers.")
    end
    UI.message("Using APP_IDENTIFIERS: #{ids.join(', ')}")
    ids
  end

  private_lane :setup_ci_keychain do
    require 'securerandom'
    keychain_name = ENV['MATCH_KEYCHAIN_NAME'] || "loopfollow_ci"
    keychain_password = ENV['MATCH_KEYCHAIN_PASSWORD'] || ENV['CI_KEYCHAIN_PASSWORD'] || SecureRandom.hex(16)
    UI.message("Using keychain '#{keychain_name}' for signing")
    create_keychain(
      name: keychain_name,
      password: keychain_password,
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )
    ENV['CI_KEYCHAIN_PASSWORD'] = keychain_password
  end

  ############################################################
  # Lanes
  ############################################################

  desc "Bootstrap certificates & provisioning profiles (App Store) via match"
  lane :certs do
    app_ids = ensure_app_identifiers!
    setup_ci_keychain
    match(
      type: "appstore",
      app_identifier: app_ids,
      readonly: false,
      git_url: ENV['MATCH_REPO'],
      git_basic_authorization: ENV['MATCH_GIT_BASIC_AUTHORIZATION'],
      storage_mode: "git",
      git_branch: ENV['MATCH_BRANCH'] || "main",
      clone_branch_directly: true,
      shallow_clone: true,
      username: ENV['MATCH_USERNAME'],
      team_id: ENV['TEAMID'],
      keychain_name: ENV['MATCH_KEYCHAIN_NAME'] || "loopfollow_ci",
      keychain_password: ENV['MATCH_KEYCHAIN_PASSWORD'] || ENV['CI_KEYCHAIN_PASSWORD'],
      verbose: false
    )
  end

  desc "Re-run match to renew/repair certs/profiles if needed"
  lane :check_and_renew_certificates do
    app_ids = ensure_app_identifiers!
    setup_ci_keychain
    match(
      type: "appstore",
      app_identifier: app_ids,
      readonly: false,
      force_for_new_devices: false,
      git_url: ENV['MATCH_REPO'],
      git_basic_authorization: ENV['MATCH_GIT_BASIC_AUTHORIZATION'],
      storage_mode: "git",
      git_branch: ENV['MATCH_BRANCH'] || "main",
      clone_branch_directly: true,
      shallow_clone: true,
      username: ENV['MATCH_USERNAME'],
      team_id: ENV['TEAMID'],
      keychain_name: ENV['MATCH_KEYCHAIN_NAME'] || "loopfollow_ci",
      keychain_password: ENV['MATCH_KEYCHAIN_PASSWORD'] || ENV['CI_KEYCHAIN_PASSWORD']
    )
  end

  desc "Build LoopFollow (Release)"
  lane :build_LoopFollow do
    app_ids = ensure_app_identifiers!
    setup_ci_keychain

    # Hent profiler/certs i readonly for selve builden
    match(
      type: "appstore",
      app_identifier: app_ids,
      readonly: true,
      git_url: ENV['MATCH_REPO'],
      git_basic_authorization: ENV['MATCH_GIT_BASIC_AUTHORIZATION'],
      storage_mode: "git",
      git_branch: ENV['MATCH_BRANCH'] || "main",
      clone_branch_directly: true,
      shallow_clone: true,
      username: ENV['MATCH_USERNAME'],
      team_id: ENV['TEAMID'],
      keychain_name: ENV['MATCH_KEYCHAIN_NAME'] || "loopfollow_ci",
      keychain_password: ENV['MATCH_KEYCHAIN_PASSWORD'] || ENV['CI_KEYCHAIN_PASSWORD']
    )

    build_num = (ENV['GITHUB_RUN_NUMBER'] || Time.now.strftime("%Y%m%d%H%M")).to_s

    ipa_path = build_app(
      workspace: "LoopFollow.xcworkspace",
      scheme: "LoopFollow",
      configuration: "Release",
      clean: true,
      output_directory: "build",
      output_name: "LoopFollow",
      build_number: build_num,
      export_method: "app-store",
      include_symbols: true,
      include_bitcode: false,
      xcargs: "DEVELOPMENT_TEAM=#{ENV['TEAMID']}"
    )
    sh("ls -lah #{ipa_path}") # synlig i loggen
    ipa_path
  end

  desc "Build + upload til intern TestFlight"
  lane :release do
    ipa = build_LoopFollow
    upload_to_testflight(
      ipa: ipa,
      distribute_external: false,
      skip_submission: true,
      skip_waiting_for_build_processing: false,
      changelog: ENV['TESTFLIGHT_CHANGELOG'] || "Automated internal build"
    )
  end

  desc "Promoter til ekstern TestFlight (krever metadata)"
  lane :release_external do
    required = %w[
      BETA_APP_DESCRIPTION
      BETA_APP_FEEDBACK_EMAIL
      BETA_CONTACT_FIRST_NAME
      BETA_CONTACT_LAST_NAME
      BETA_CONTACT_EMAIL
      BETA_CONTACT_PHONE
    ]
    missing = required.select { |k| ENV[k].to_s.strip.empty? }
    if missing.any?
      UI.user_error!("Missing required env for external TestFlight: #{missing.join(', ')}. Add them as repository variables/secrets and re-run.")
    end

    ipa = build_LoopFollow
    upload_to_testflight(
      ipa: ipa,
      distribute_external: true,
      groups: (ENV['TESTFLIGHT_EXTERNAL_GROUPS'] || "").split(",").map(&:strip).reject(&:empty?),
      beta_app_description: ENV['BETA_APP_DESCRIPTION'],
      beta_app_feedback_email: ENV['BETA_APP_FEEDBACK_EMAIL'],
      submit_for_beta_review: true,
      demo_account_required: false,
      beta_app_review_info: {
        contact_first_name: ENV['BETA_CONTACT_FIRST_NAME'],
        contact_last_name:  ENV['BETA_CONTACT_LAST_NAME'],
        contact_email:      ENV['BETA_CONTACT_EMAIL'],
        contact_phone:      ENV['BETA_CONTACT_PHONE'],
        notes:              ENV['BETA_REVIEW_NOTES'] || ""
      },
      changelog: ENV['TESTFLIGHT_CHANGELOG'] || "Automated external build"
    )
  end
end
